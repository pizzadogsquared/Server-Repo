<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link rel="stylesheet" href="/styles/home.css">
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="home-container">
    <h1>Welcome to Bee Balanced</h1>
    <p>Your daily well-being tracker.</p>

    <div class="home-buttons">
      <a href="/survey" class="btn">Take Today's Survey</a>
    </div>

    <!-- Bee Garden Virtual Pet Window -->
    <div id="bee-garden-container">
      <div id="hive-scene">
        <canvas id="bee-animation-canvas"></canvas>
        <div id="flower-garden">
        </div>
      </div>
    </div>
    <a href="/shop" class="btn">Visit Shop</a>

    <!-- Calendar Section -->
    <div class="calendar">
      <div class="calendar-header">
      
        <div class="month-switcher">
          <button onclick="changeMonth(-1)">←</button>
          <h2 id="calendar-month" class="calendar-month">Month</h2>
          <button onclick="changeMonth(1)">→</button>
        </div>

        <div class="calendar-controls">
          <button onclick="changeCalendarType(-1)">←</button>
          <h3 id="calendar-type" class="calendar-type">Health Type</h3>
          <button onclick="changeCalendarType(1)">→</button>
        </div>

      </div>
      <table>
        <thead>
          <tr>
            <th>Sunday</th><th>Monday</th><th>Tuesday</th>
            <th>Wednesday</th><th>Thursday</th><th>Friday</th><th>Saturday</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <!-- Feedback Section -->
    <div class="chart-feedback-container">
      <% const sections = ['overall', 'mental', 'physical']; %>
      <% sections.forEach(section => { %>
        <div class="chart-feedback-item">
          <h2><%= section.charAt(0).toUpperCase() + section.slice(1) %> Health</h2>
          <div class="feedback-card">
            <h3><%= section.charAt(0).toUpperCase() + section.slice(1) %> Health</h3>
            <% const feedback = section === 'overall' ? overallFeedback : section === 'mental' ? mentalFeedback : physicalFeedback; %>
            <% if (feedback && feedback.length > 0) { %>
              <select onchange="showAdvice(this.value, '<%= section %>')">
                <option value="">Choose an area to improve</option>
                <% feedback.forEach((item, index) => { %>
                  <option value="<%= section %>Advice<%= index %>"><%= item.question %></option>
                <% }) %>
              </select>
              <% feedback.forEach((item, index) => { %>
                <div id="<%= section %>Advice<%= index %>" class="advice-text" style="display: none;">
                  <p><%= item.advice %></p>
                </div>
              <% }) %>
            <% } else { %>
              <p class="no-feedback">No feedback yet. Complete the <%= section %> survey!</p>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- Charts Section -->
    <div class="chart-feedback-container">
      <% sections.forEach(section => { %>
        <div class="chart-feedback-item">
          <div id="<%= section %>Chart" class="chart"></div>
          <div class="chart-button">
            <a 
              href="<%= section === 'overall' ? '/survey' : `/survey?section=${section}` %>" 
              class="btn">
              Take <%= section.charAt(0).toUpperCase() + section.slice(1) %> Survey
            </a>
          </div>
        </div>
      <% }); %>
    </div>

    <script>
      window.plantedFlowers = <%- JSON.stringify(plantedFlowers) %>;
    </script>

    <script>
      window.wellnessScores = [
        ...<%- JSON.stringify(overallData || []) %>,
        ...<%- JSON.stringify(mentalData || []) %>,
        ...<%- JSON.stringify(physicalData || []) %>
      ];
    </script>
    <script src="/js/beeAnimation.js"></script>
    <script>
      function showAdvice(id, prefix) {
        document.querySelectorAll(`div[id^="${prefix}Advice"]`).forEach(el => el.style.display = 'none');
        if (id) document.getElementById(id).style.display = 'block';
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const charts = {
          overall: <%- JSON.stringify(overallData) %>,
          mental: <%- JSON.stringify(mentalData) %>,
          physical: <%- JSON.stringify(physicalData) %>
        };
        function drawChart(chartId, title, data) {
        const x = data.map(e => e.date);
        const y = data.map(e => e.avgScore);

        if (!x.length) {
          document.getElementById(chartId).innerHTML = 
          '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background-color: #cae9f6; border-radius: 8px; border: 2px solid #ffd700; font-size: 24px; font-weight: bold; color: #ffd700; text-align: center; box-sizing: border-box;">No data for the past 2 weeks.</div>';
          return;
        }
        const lastX = x.at(-1);
        const lastY = y.at(-1);

        Plotly.newPlot(chartId, [{
          x,
          y,
          type: 'scatter',
          mode: 'lines+markers',
          marker: { color: '#FFFFFF' },
          line: { color: '#FFFFFF' }
        }], {
          title: title,
          titlefont: { color: '#FFD700' },
          xaxis: {
            title: "Date",
            type: 'category',
            tickfont: { color: '#37AE0F' },
            linecolor: '#37AE0F'
          },
          yaxis: {
            title: "Score",
            range: [0, 10],
            tickfont: { color: '#37AE0F' },
            linecolor: '#37AE0F'
          },
          plot_bgcolor: '#cae9f6',
          paper_bgcolor: '#cae9f6',
          images: [{
            source: "/images/bee.gif",
            x: lastX,
            y: lastY,
            xref: "x",
            yref: "y",
            sizex: 3,
            sizey: 3,
            xanchor: "center",
            yanchor: "middle",
            layer: "above"
          }]
        });
      }

        drawChart("overallChart", "Overall Health (Last 2 Weeks)", charts.overall);
        drawChart("mentalChart", "Mental Health (Last 2 Weeks)", charts.mental);
        drawChart("physicalChart", "Physical Health (Last 2 Weeks)", charts.physical);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Calendar data:", <%- JSON.stringify(timelineData) %>);
        const calendarData = {
          overall: <%- JSON.stringify(timelineData.overall) %>,
          mental: <%- JSON.stringify(timelineData.mental) %>,
          physical: <%- JSON.stringify(timelineData.physical) %>
        };

        let currentTypeIndex = 0;
        let currentMonthOffset = 0;
        const calendarTypes = ['overall', 'mental', 'physical'];

        // show the color for the score
        function colorForScore(score) {
          if (score >= 8) return "#00c853";
          if (score >= 6) return "#64dd17";
          if (score >= 4) return "#ffd600";
          if (score >= 2) return "#ff6d00";
          return "#d50000";
        }

        function renderCalendar(type, monthOffset) {
          const today = new Date();
          const displayDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);

          const currentMonth = displayDate.getMonth();
          const currentYear = displayDate.getFullYear();
          const currentMonthName = displayDate.toLocaleString('default', { month: 'long' });
          const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
          const startingDay = new Date(currentYear, currentMonth, 1).getDay();

          const monthElem = document.getElementById("calendar-month");
          const typeElem = document.getElementById("calendar-type");
          const entries = calendarData[type];
          const calendar = [];
          let week = [];

          if (monthElem) monthElem.innerText = `${currentMonthName} ${currentYear}`;
          if (typeElem) typeElem.innerText = `${type.charAt(0).toUpperCase() + type.slice(1)} Health`;

          for (let i = 0; i < startingDay; i++) week.push(null);

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const entry = entries.find(e => e.day === dateStr);
            week.push({
              number: day,
              avgScore: entry?.avgScore ?? null
            });

            if (week.length === 7) {
              calendar.push(week);
              week = [];
            }
          }

          while (week.length < 7) week.push(null);
          calendar.push(week);

          const calendarBody = document.getElementById("calendar-body");
          calendarBody.innerHTML = "";
          calendar.forEach(week => {
            const row = document.createElement("tr");
            week.forEach(cell => {
              const td = document.createElement("td");
              if (cell) {
                const div = document.createElement("div");
                div.className = "date-cell";
                div.style.backgroundColor = cell.avgScore !== null ? colorForScore(cell.avgScore) : "#eeeeee";
                const numberDiv = document.createElement("div");
                numberDiv.className = "date-number";
                numberDiv.textContent = cell.number;

                const scoreDiv = document.createElement("div");
                scoreDiv.className = "date-score";
                // show the score on the calendar
                if (cell.avgScore !== null) {
                  scoreDiv.textContent = Math.round(cell.avgScore * 10) / 10;
                }

                div.appendChild(numberDiv);
                div.appendChild(scoreDiv);

                td.appendChild(div);
              } else {
                td.classList.add("empty");
              }
              row.appendChild(td);
            });
            calendarBody.appendChild(row);
          });
        }

        window.changeCalendarType = function (direction) {
          currentTypeIndex = (currentTypeIndex + direction + calendarTypes.length) % calendarTypes.length;
          renderCalendar(calendarTypes[currentTypeIndex], currentMonthOffset);
        };

        window.changeMonth = function (direction) {
          currentMonthOffset += direction;
          renderCalendar(calendarTypes[currentTypeIndex], currentMonthOffset);
        };

        renderCalendar(calendarTypes[currentTypeIndex], currentMonthOffset);
      });
    </script>

  </div>
  <footer class="home-footer">
    <p>If you have any questions, please contact <strong>Davis Yi</strong> at 
      <a href="mailto:davisdaehanyi@nau.edu">davisdaehanyi@nau.edu</a>.
    </p>
  </footer>
</body>
</html>
