<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link rel="stylesheet" href="/styles/home.css">
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="home-container">
    <h1>Welcome to Bee Balanced</h1>
    <p>Your daily well-being tracker.</p>

    <div class="home-buttons">
      <a href="/survey" class="btn">Take Today's Survey</a>
    </div>

    <!-- Bee Garden Virtual Pet Window -->
    <div id="bee-garden-container">
      <div id="hive-scene">
        <canvas id="bee-animation-canvas"></canvas>
        <div id="flower-garden">
        </div>
      </div>
    </div>

    <!-- Calendar Section -->
    <div class="calendar">
      <div class="calendar-header">
        <h2 id="calendar-month" class="calendar-month">Month</h2>
        <div class="calendar-controls">
          <button onclick="changeCalendar(-1)">←</button>
          <h3 id="calendar-type" class="calendar-type">Health Type</h3>
          <button onclick="changeCalendar(1)">→</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Sunday</th><th>Monday</th><th>Tuesday</th>
            <th>Wednesday</th><th>Thursday</th><th>Friday</th><th>Saturday</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <!-- Feedback Section -->
    <div class="chart-feedback-container">
      <% const sections = ['overall', 'mental', 'physical']; %>
      <% sections.forEach(section => { %>
        <div class="chart-feedback-item">
          <h2><%= section.charAt(0).toUpperCase() + section.slice(1) %> Health</h2>
          <div class="feedback-card">
            <h3><%= section.charAt(0).toUpperCase() + section.slice(1) %> Health</h3>
            <% const feedback = section === 'overall' ? overallFeedback : section === 'mental' ? mentalFeedback : physicalFeedback; %>
            <% if (feedback && feedback.length > 0) { %>
              <select onchange="showAdvice(this.value, '<%= section %>')">
                <option value="">Choose an area to improve</option>
                <% feedback.forEach((item, index) => { %>
                  <option value="<%= section %>Advice<%= index %>"><%= item.question %></option>
                <% }) %>
              </select>
              <% feedback.forEach((item, index) => { %>
                <div id="<%= section %>Advice<%= index %>" class="advice-text" style="display: none;">
                  <p><%= item.advice %></p>
                </div>
              <% }) %>
            <% } else { %>
              <p class="no-feedback">No feedback yet. Complete the <%= section %> survey!</p>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- Charts Section -->
    <div class="chart-feedback-container">
      <% sections.forEach(section => { %>
        <div class="chart-feedback-item">
          <div id="<%= section %>Chart" class="chart"></div>
        </div>
      <% }); %>
    </div>

    <script>
      window.wellnessScores = [
        ...<%- JSON.stringify(overallData || []) %>,
        ...<%- JSON.stringify(mentalData || []) %>,
        ...<%- JSON.stringify(physicalData || []) %>
      ];
    </script>
    <script src="/js/beeAnimation.js"></script>
    <script>
      function showAdvice(id, prefix) {
        document.querySelectorAll(`div[id^="${prefix}Advice"]`).forEach(el => el.style.display = 'none');
        if (id) document.getElementById(id).style.display = 'block';
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const overallData = <%- JSON.stringify(overallData) %> || [null, null, null, null, null, null, null];
        const mentalData = <%- JSON.stringify(mentalData) %> || [null, null, null, null, null, null, null];
        const physicalData = <%- JSON.stringify(physicalData) %> || [null, null, null, null, null, null, null];
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function drawChart(chartId, title, data) {
          const validIndices = data.map((val, idx) => ({ val, idx })).filter(entry => entry.val !== null && entry.val !== 0);
          const lastEntry = validIndices.at(-1);
          if (!lastEntry) return;
          const lastX = days[lastEntry.idx];
          const lastY = data[lastEntry.idx];

          Plotly.newPlot(chartId, [{
            x: days,
            y: data,
            type: 'scatter',
            mode: 'lines+markers',
            marker: { color: '#FFFFFF' },
            line: { color: '#FFFFFF' }
          }], {
            title: title,
            titlefont: { color: '#FFD700' },
            xaxis: { title: "Days", tickfont: { color: '#37AE0F' }, linecolor: '#37AE0F' },
            yaxis: { title: "Score", range: [0, 10], tickfont: { color: '#37AE0F' }, linecolor: '#37AE0F' },
            plot_bgcolor: '#cae9f6',
            paper_bgcolor: '#cae9f6',
            images: [{
              source: "/images/bee.gif",
              x: lastX,
              y: lastY,
              xref: "x",
              yref: "y",
              sizex: 3,
              sizey: 3,
              xanchor: "center",
              yanchor: "middle",
              layer: "above"
            }]
          });
        }

        drawChart("overallChart", "Overall Health Progress", overallData);
        drawChart("mentalChart", "Mental Health Progress", mentalData);
        drawChart("physicalChart", "Physical Health Progress", physicalData);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const calendarData = {
          overall: <%- JSON.stringify(calendarTimeline.overall) %>,
          mental: <%- JSON.stringify(calendarTimeline.mental) %>,
          physical: <%- JSON.stringify(calendarTimeline.physical) %>
        };

        let currentTypeIndex = 0;
        const calendarTypes = ['overall', 'mental', 'physical'];

        function colorForScore(score) {
          if (score >= 8) return "#00c853";
          if (score >= 6) return "#64dd17";
          if (score >= 4) return "#ffd600";
          if (score >= 2) return "#ff6d00";
          return "#d50000";
        }

        function renderCalendar(type) {
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
          const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
          const firstDay = new Date(currentYear, currentMonth, 1).getDay();
          const entries = calendarData[type];

          document.getElementById("calendar-month").innerText = today.toLocaleString('default', { month: 'long' });
          document.getElementById("calendar-type").innerText = `${type.charAt(0).toUpperCase() + type.slice(1)} Health`;

          const calendar = [];
          let week = [];

          for (let i = 0; i < firstDay; i++) week.push(null);
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const entry = entries.find(e => e.day === dateStr);
            week.push({ number: day, avgScore: entry?.avgScore ?? null });
            if (week.length === 7) { calendar.push(week); week = []; }
          }
          while (week.length < 7) week.push(null);
          calendar.push(week);

          const calendarBody = document.getElementById("calendar-body");
          calendarBody.innerHTML = "";

          calendar.forEach(rowData => {
            const row = document.createElement("tr");
            rowData.forEach(cell => {
              const td = document.createElement("td");
              if (cell) {
                const div = document.createElement("div");
                div.className = "date-cell";
                div.style.backgroundColor = cell.avgScore !== null ? colorForScore(cell.avgScore) : "#eeeeee";
                const numberDiv = document.createElement("div");
                numberDiv.className = "date-number";
                numberDiv.textContent = cell.number;
                div.appendChild(numberDiv);
                td.appendChild(div);
              } else {
                td.classList.add("empty");
              }
              row.appendChild(td);
            });
            calendarBody.appendChild(row);
          });
        }

        window.changeCalendar = function (direction) {
          currentTypeIndex = (currentTypeIndex + direction + calendarTypes.length) % calendarTypes.length;
          renderCalendar(calendarTypes[currentTypeIndex]);
        };

        renderCalendar(calendarTypes[currentTypeIndex]);
      });
    </script>
  </div>
</body>
</html>
